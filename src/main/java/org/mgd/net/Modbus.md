[回到主目录](/README.md)
# ModbusTCP协议基础
## 简介
```shell
    modbus由MODICON公司于1979年开发，是一种工业现场总线协议标准。1996年施耐德公司推出基于以太网TCP/IP的modbus协议：modbusTCP。

标准的Modbus协议物理层接口有RS232、RS422、RS485和以太网接口，采用master/slave方式通信，客户机作为主站，向服务器发送请求；服务器（从站）接到请求后，对请求进行分析并作出应答。

串口（RS232、RS422、RS485）: RTU/ASCII 
参数: 波特率、数据位、停止位和奇偶校验

以太网接口: TCP
参数: IP和端口（port 默认502）
```
## 协议桢

    ModbusTCP的数据帧可分为两部分：MBAP+PDU。

- MBAP:modbus协议头
    |事务处理标|协议标识|长度|单元标识符|
    |----|----|----|----|
    |2字节|2字节|2字节|1字节|

    |内容	|解释|
    |----|----|    
    |事务处理标识|	可以理解为报文的序列号，一般每次通信之后就要加1以区别不同的通信数据|报文。|
    |协议标识符|	00 00表示ModbusTCP协议。|
    |长度|	表示接下来的数据长度，单位为字节。|
    |单元标识符|	可以理解为设备地址。|


- PDU: 协议数据单元
    ```shell
    PDU由功能码+数据组成。功能码为1字节，数据长度不定，由具体功能决定。
    ```
    - 功能码
        ```shell
        Modbus的操作对象有四种：线圈、离散输入、保持寄存器、输入寄存器。
        ```
         |代码	|中文名称	|英文名	|位操作/字操作	|操作数量|
         |----|----|----|----|----|
        |01	|读线圈状态	|READ COIL STATUS	|位操作	|单个或多个|
        |02	|读离散输入状态	|READ INPUT STATUS	|位操作	|单个或多个|
        |03	|读保持寄存器	|READ HOLDING REGISTER	|字操作	|单个或多个|
        |04	|读输入寄存器	|READ INPUT REGISTER	|字操作	|单个或多个|
        |05	|写线圈状态	|WRITE SINGLE COIL	|位操作	|单个|
        |06	|写单个保持寄存器	|WRITE SINGLE REGISTER	|字操作	|单个|
        |15	|写多个线圈	|WRITE MULTIPLE COIL	|位操作	|多个|
        |16	|写多个保持寄存器	|WRITE MULTIPLE REGISTER	|字操作	|多个|

    
    - PDU详细结构

        - 0x01：读线圈
        ```shell
        在从站中读1~2000个连续线圈状态，ON=1,OFF=0
        请求：MBAP 功能码 起始地址H 起始地址L 数量H 数量L（共12字节）
        响应：MBAP 功能码 数据长度 数据（一个地址的数据为1位）
        如：在从站0x01中，读取开始地址为0x0002的线圈数据，读0x0008位
        00 01 00 00 00 06 01 01 00 02 00 08
        回：数据长度为0x01个字节，数据为0x01，第一个线圈为ON，其余为OFF
        00 01 00 00 00 04 01 01 01 01
        ```
        - 0x05：写单个线圈
        ```shell
        将从站中的一个输出写成ON或OFF，0xFF00请求输出为ON,0x000请求输出为OFF

        请求：MBAP 功能码 输出地址H 输出地址L 输出值H 输出值L（共12字节）
        响应：MBAP 功能码 输出地址H 输出地址L 输出值H 输出值L（共12字节）
        如：将地址为0x0003的线圈设为ON
            00 01 00 00 00 06 01 05 00 03 FF 00
        回：写入成功
            00 01 00 00 00 06 01 05 00 03 FF 00
        ```
## 常见错误

|CODE	|NAME	|描述|
|----|----|----|
|01	 |ILLEGAL FUNCTION  	|非法功能码，slave端不支持该功能码
|02	 |ILLEGAL DATA ADDRESS  	|非法数据地址，master端请求的数据范围超出slave端设置的范围
|03	 |ILLEGAL DATA VALUE  	|非法数据值，提交存储的数值范围超长
|04	 |SERVER DEVICE FAILURE  	|服务器运行时发生不可恢复的错误
|05	 |ACKNOWLEDGE  	|服务器已接受该请求，正在运行正在处理它，但需要很长的时间必须这样做。此响应返回给防止在中发生超时错误
|06	 |SERVER DEVICE BUSY  	|服务器处于繁忙状态
|08	 |MEMORY PARITY ERROR  |内存奇偶校验错误，一般用于功能20/21
|0A	 |GATEWAY PATH UNAVAILABLE  	|与网关结合使用,通常意味着网关配置错误或者超载。
|0B	 |GATEWAY TARGET DEVICE FAILED TO RESPOND  	|与网关结合使用,通常意味着设备不可用